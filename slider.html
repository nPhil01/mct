<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Maptest</title>

	<link rel="stylesheet" href="./leaflet/leaflet.css" />
	<link rel="stylesheet" href="./leaflet-search.min.css" />
	<script src="./leaflet/leaflet.js"></script>
	<script src="./jquery.min.js"></script>
	<script src="./jquery-ui.min.js"></script>
	<script src="./leaflet-search.min.js"></script>
	<script src="./us_states.js"></script>
	<script src="./us_states_2_variation.js"></script>
	<style>
		body {
			font-family: Sans-Serif;
		}

		.map {
			height: 450px;
			position: absolute;
			top: 1px;
			left: 1px;
		}

		#map-left {
			width: 900px;
			/* Workaround, see GeoJSON & map data loading... */
			z-index: 30;
		}

		#map-mid {
			width: 900px;
			/* Also part of the workaround. */
			z-index: 20;
		}

		#map-right {
			width: 900px;
			z-index: 10;
		}

		#container {
			position: relative;
			border: 1px solid gray;
			display: table;
			z-index: 50;
			width: 1040px;
			height: 450px;
			border-radius: 2px 2px 0px 0px;
			margin: 0 auto;
		}

		#labels {
			position: relative;
			left: 0px;
			z-index: 10;
		}

		#labelComparison {
			position: absolute;
			left: 625px;
		}

		#labelBefore {
			position: absolute;
			left: 300px;
		}

		#labelAfter {
			position: absolute;
			left: 900px;
		}

		h1,
		p {
			text-align: center;
		}

		h1 {
			margin: 10px;
		}

		#dragwrapper-left {
			position: absolute;
			left: 285px;
			z-index: 80;
		}

		#dragwrapper-right {
			position: absolute;
			left: 585px;
			z-index: 80;
		}

		#drag-left {
			position: absolute;
			width: 2px;
			background: rgb(136, 136, 136) none repeat scroll;
			height: 450px;
			left: 15px;
			max-width: 2px;
		}

		#drag-right {
			position: absolute;
			width: 2px;
			background: rgb(136, 136, 136) none repeat scroll;
			height: 450px;
			left: 15px;
			max-width: 2px;
		}

		#draghandle-left {
			position: relative;
			cursor: pointer;
			z-index: 100;
			left: -15px;
		}

		#draghandle-right {
			position: relative;
			cursor: pointer;
			z-index: 100;
			left: -15px;
			top: 426px;
		}

		#constraint {
			position: absolute;
			top: 1px;
			left: 1px;
			height: 100%;
			width: 870px;
		}

		#infobox {
			border: 1px solid gray;
			border-top: 0px;
			display: block;
			width: 1040px;
			border-radius: 0px 0px 2px 2px;
			margin: 0 auto;
			position: relative;
		}

		#infotext {
			margin: 0;
			margin-right: 5px;
			float: right;
			vertical-align: middle;
		}

		#legendAll {
			position: absolute;
			left: 905px;
		}
		/* Workaround for hiding the legend. */

		.leaflet-control-attribution {
			display: none;
		}
	</style>

</head>

<body>
	<h1>Comparison Slider</h1><br>
	<div id="labels">
		<h4 id="labelBefore">Map Before: US-States</h4>
		<h4 id="labelComparison">Comparison Map</h4>
		<h4 id="labelAfter">Map After: US-States</h4>
	</div><br><br>
	<div id="container">
		<div id="constraint"></div>
		<div id="dragwrapper-left">
			<div id="drag-left">
				<img id="draghandle-left" src="./sliders.png">
			</div>
		</div>
		<div id="dragwrapper-right">
			<div id="drag-right">
				<img id="draghandle-right" src="./sliders.png">
			</div>
		</div>
		<div id="map-left" class="map"></div>
		<div id="map-mid" class="map"></div>
		<div id="map-right" class="map"></div>
		<div id="legendAll"></div>
	</div>
	<div id="infobox">
		<br>
		<div id="search"></div>
		<button type="button" class="togglebutton" onclick="showMap('left')">Left Map</button>
		<button type="button" class="togglebutton" onclick="showMap('central')">Central Map</button>
		<button type="button" class="togglebutton" onclick="showMap('right')">Right Map</button>
		<button type="button" class="togglebutton" onclick="showMap('all')">All Maps</button>
		<div> <input id="numberColorDif" type="number" min="3" max="9" step="2" value="7"><button type="button" onclick="selectNumberDifFunc()">Select</button></div>
		<p id="infotext">Hover over choropleth shapes to show more information.</p><br><br>
	</div>
	<br>
	<p>&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors</p><br>
	<script>
		// set up 3 maps
		var leftmap = L.map('map-left', {
			center: [51.505, -0.09],
			zoom: 13,
			zoomAnimation: false,
			attributionControl: true,
			zoomControl: false
		});
		var midmap = L.map('map-mid', {
			center: [51.505, -0.09],
			zoom: 13,
			zoomAnimation: false,
			attributionControl: false,
			zoomControl: false
		});
		var rightmap = L.map('map-right', {
			center: [51.505, -0.09],
			zoom: 13,
			zoomAnimation: false,
			attributionControl: false,
			zoomControl: false
		});

		var basemap = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';
		var basemap_options = {
			maxZoom: 18
		};

		L.tileLayer(basemap, basemap_options).addTo(leftmap);
		L.tileLayer(basemap, basemap_options).addTo(midmap);
		L.tileLayer(basemap, basemap_options).addTo(rightmap);

		// avoid endless recursion when synchronizing the map
		var recursing = 0;

		function getCenterDistance(a, b) {
			return (b.getSize().x / 2) - (a.getSize().x / 2);
		}

		function syncMaps(source, target) {
			if (recursing > 3) {
				recursing = 0;
				return;
			}

			recursing += 1;

			let offset = getCenterDistance(source, target);

			let zoom = source.getZoom();
			let center = source.getCenter();
			let pixels = source.latLngToLayerPoint(center);
			pixels.x += offset;

			target.setView(source.layerPointToLatLng(pixels), source.getZoom(), {
				animate: false
			});
		}

		// register synchronization function
		leftmap.on('move', function () {
			syncMaps(leftmap, rightmap);
			syncMaps(leftmap, midmap);
		});

		midmap.on('move', function () {
			syncMaps(midmap, leftmap);
			syncMaps(midmap, rightmap);
		});

		rightmap.on('move', function () {
			syncMaps(rightmap, leftmap);
			syncMaps(rightmap, midmap);
		});

		// create draggable handles
		$('#dragwrapper-left').draggable({
			containment: $('#constraint'),
			drag: $('#drag-left'),
			stop: $('#drag-left'),
			axis: "x"
		});
		$('#dragwrapper-right').draggable({
			containment: $('#constraint'),
			drag: $('#drag-right'),
			stop: $('#drag-right'),
			axis: "x"
		});

		$('#dragwrapper-left').on('drag', function () {
			$('#map-left').width($('#dragwrapper-left').position().left + 16);

			// make sure the left wrapper doesn't overlap the right one
			if ($('#dragwrapper-left').position().left + 16 > $('#dragwrapper-right').position().left) {

				$("#dragwrapper-right").css({
					left: ($('#dragwrapper-left').position().left + 16) + 'px'
				});

				$('#map-mid').width($('#dragwrapper-right').position().left + 16);
			}
		});

		$('#dragwrapper-right').on('drag', function () {
			$('#map-mid').width($('#dragwrapper-right').position().left + 16);

			// make sure the right wrapper doesn't overlap the left one
			if ($('#dragwrapper-right').position().left < $('#dragwrapper-left').position().left + 16) {

				$("#dragwrapper-left").css({
					left: ($('#dragwrapper-right').position().left - 16) + 'px'
				});

				$('#map-left').width($('#dragwrapper-left').position().left + 16);
			}

		});

		// workaround for draggable bug
		var workaround_yl = $('#dragwrapper-left').position().top + 1;
		var workaround_yr = $('#dragwrapper-left').position().top + 1;

		$('#dragwrapper-left').on('dragstop', function () {
			$("#dragwrapper-left").css({
				top: workaround_yl + 'px'
			});
		});

		$('#dragwrapper-right').on('dragstop', function () {
			$("#dragwrapper-right").css({
				top: workaround_yr + 'px'
			});
		});

		// make sure both datasets have the same size
		if (statesData.features.size != statesData2.features.size) {
			alert("Error: datasets can't be compared");
			exit;
		}

		// the functions from the tutorial to color and style the maps
		function getColor(d) {
			return d > 1000 ? '#800026' :
				d > 500 ? '#BD0026' :
				d > 200 ? '#E31A1C' :
				d > 100 ? '#FC4E2A' :
				d > 50 ? '#FD8D3C' :
				d > 20 ? '#FEB24C' :
				d > 10 ? '#FED976' :
				'#FFEDA0';
		}

		function style(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColor(feature.properties.density)
			};
		}

		function resetInfo() {
			$('#infotext')[0].innerHTML = "Hover over choropleth shapes to show more information.";
		}

		function setInfo(properties) {
			if (properties.density === undefined) { // in this case it's midmap
				$('#infotext')[0].innerHTML = properties.name + ": " + properties.density_left + " â†’ " +
					properties.density_right + " (" + (properties.density_diff < 0 ? properties.density_diff : ("+" + properties.density_diff)) +
					")";
			} else { // otherwise it's right or left
				$('#infotext')[0].innerHTML = properties.name + ": " + properties.density;
			}
		}

		function highlightFeature(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 3,
				color: '#55DDFF',
				dashArray: '',
				fillOpacity: 1
			});

			if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				layer.bringToFront();
			}

			setInfo(layer.feature.properties);

		}

		function resetHighlightR(e) {
			geojson_right.resetStyle(e.target);
			resetInfo();
		}

		function resetHighlightL(e) {
			geojson_left.resetStyle(e.target);
			resetInfo();
		}

		function onEachFeatureR(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlightR
			});
		}

		function onEachFeatureL(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlightL
			});
		}


		// load data into the maps
		var geojson_left = L.geoJson(statesData, {
			style: style,
			onEachFeature: onEachFeatureL
		}).addTo(leftmap);
		
		var geojson_right = L.geoJson(statesData2, {
			style: style,
			onEachFeature: onEachFeatureR
		}).addTo(rightmap);

		var searchControl = new L.Control.Search({
			layer: geojson_left,
			propertyName: 'name',
			marker: false,
			moveToLocation: function (latlng, title, leftmap) {
				//map.fitBounds( latlng.layer.getBounds() );
				var zoom = leftmap.getBoundsZoom(latlng.layer.getBounds());
				leftmap.setView(latlng, zoom); // access the zoom
			}
		});

		searchControl.on('search:locationfound', function (e) {

			if (e.layer._popup)
				e.layer.openPopup();

		}).on('search:collapsed', function (e) {

			geojson_left.eachLayer(function (layer) { //restore feature color
				geojson_left.resetStyle(layer);
			});
		});

		searchControl.on('search:collapsed', function (e) {
			leftmap.setView([37.8, -96], 4);
		});

		leftmap.addControl(searchControl); //initialise search control

		var htmlObject = searchControl.getContainer();

		var a = document.getElementById('search');

		function setParent(el, newParent) {
			newParent.appendChild(el);
		}
		setParent(htmlObject, a);

		function showMap(whichMap) {
			switch (whichMap) {
				case "left":
					document.getElementById("dragwrapper-left").style.left = "850px";
					document.getElementById("dragwrapper-right").style.left = "870px";
					updateSlider();
					break;
				case "central":
					document.getElementById("dragwrapper-left").style.left = "0px";
					document.getElementById("dragwrapper-right").style.left = "870px";
					updateSlider();
					break;
				case "right":
					document.getElementById("dragwrapper-left").style.left = "0px";
					document.getElementById("dragwrapper-right").style.left = "20px";
					updateSlider();
					break;
				case "all":
					document.getElementById("dragwrapper-left").style.left = "285px";
					document.getElementById("dragwrapper-right").style.left = "585px";
					updateSlider();
			}
		}

		function updateSlider() {
			$('#map-left').width($('#dragwrapper-left').position().left + 16);
			$('#map-mid').width($('#dragwrapper-right').position().left + 16);
		}

		// creating the difference map + color scale
		var diffData = {
			"type": "FeatureCollection",
			"features": []
		};
		var colormin = 0;
		var colormax = 0;
		var leftlowerhalf = 0;
		var leftmiddlequarter = 0;

		var rightmiddlequarter = 0;
		var rightupperhalf = 0;
		// the inner quarters are < or > 0

		for (let dataset = 0; dataset < statesData.features.length; dataset++) {
			let ldata = statesData.features[dataset];
			let rdata = statesData2.features[dataset];

			// generate difference choropleth dataset
			let newdata = {
				type: "Feature",
				id: "" + (dataset + 1) + "",
				properties: {
					name: ldata.properties.name,
					density_diff: rdata.properties.density - ldata.properties.density,
					density_left: ldata.properties.density,
					density_right: rdata.properties.density
				},
				geometry: ldata.geometry
			};

			// search for lowest/highest values
			if (newdata.properties.density_diff < colormin) colormin = newdata.properties.density_diff;
			if (newdata.properties.density_diff > colormax) colormax = newdata.properties.density_diff;
			diffData.features.push(newdata);
		}

		// create color scale
		var colorscaleDif = [colormin/2,colormin/4, colormin/6,0,colormax/6,colormax/4,colormax/2];

		function getColorDensity(d,n) {
			switch(n){
				case 3: return getColorDensity3(d); break;
				case 5: return getColorDensity5(d); break;
				case 7: return getColorDensity7(d); break;
				case 9: return getColorDensity9(d); break;
			}
		}

		function styleDifference(feature) {
			document.getElementById("numberColorDif").value = 9;
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity(feature.properties.density_diff, 9)
			};
		}

		function resetHighlightM(e) {
		selectNumberDifFunc();
		resetInfo();
		}

		function onEachFeatureM(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlightM
			});
		}

		var geojson_mid = L.geoJson(diffData, {
			style: styleDifference,
			onEachFeature: onEachFeatureM
		}).addTo(midmap);

		// workaround reset for shape offset bug
		$('#map-left').width(300);
		$('#map-mid').width(600);

		// call syncMaps to synchronize at the beginning
		rightmap.setView([37.8, -96], 4);
		syncMaps(rightmap, leftmap);
		syncMaps(rightmap, midmap);

		// create the legend of the right and left map
		createLegend = function (label) {
			var div = '<div style="width:130px"><h4>' + label + '</h4>';
			var grades = [0, 10, 20, 50, 100, 200, 500, 1000];


			for (var i = 0; i < grades.length; i++) {
				// workaround for upper boundary
				let upper_value = i <grades.length - 1 ? grades[i + 1] : Number.MAX_VALUE;
				div += '<div class="grade' + grades[i] + '" ' +
					'onmouseover="areahighlight(' + grades[i] + ',' + upper_value + ');" ' +
					'onmouseout="areahighlightstop(' + grades[i] + ',' + upper_value + ')" ' +
					'style="background:' + getColor(grades[i] + 1) + ';">' +
					grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '</div>' : '+</div>');
			}

			div += '</div>';
			return div;
		};

		//Highlighting the areas with hovering the legend
		areahighlight = function (grade1, grade2) {
			for (var i = 0; i < Object.values(geojson_left._layers).length; i++) {
				if (Object.values(geojson_left._layers)[i].feature.properties.density > grade1 && Object.values(geojson_left._layers)[
						i].feature.properties.density < grade2) {
					var letid = Object.values(geojson_left._layers)[i]._leaflet_id;
					geojson_left._layers[letid].setStyle({
						weight: 3,
						color: '#55DDFF',
						dashArray: '',
						fillOpacity: 1
					});
					if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
						geojson_left._layers[letid].bringToFront();
					}
				}
			}
			for (var i = 0; i < Object.values(geojson_right._layers).length; i++) {
				if (Object.values(geojson_right._layers)[i].feature.properties.density > grade1 && Object.values(geojson_right._layers)[
						i].feature.properties.density < grade2) {
					var letid = Object.values(geojson_right._layers)[i]._leaflet_id;
					geojson_right._layers[letid].setStyle({
						weight: 3,
						color: '#55DDFF',
						dashArray: '',
						fillOpacity: 1
					});
					if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
						geojson_right._layers[letid].bringToFront();
					}
				}
			}
		}

		//Stop highlighting the areas when leaving the part of the legend
		areahighlightstop = function (grade1, grade2) {
			for (var i = 0; i < Object.values(geojson_left._layers).length; i++) {
				if (Object.values(geojson_left._layers)[i].feature.properties.density > grade1 && Object.values(geojson_left._layers)[
						i].feature.properties.density < grade2) {
					var letid = Object.values(geojson_left._layers)[i]._leaflet_id;
					geojson_left.resetStyle(geojson_left._layers[letid]);
				}
			}
			for (var i = 0; i < Object.values(geojson_right._layers).length; i++) {
				if (Object.values(geojson_right._layers)[i].feature.properties.density > grade1 && Object.values(geojson_right._layers)[
						i].feature.properties.density < grade2) {
					var letid = Object.values(geojson_right._layers)[i]._leaflet_id;
					geojson_right.resetStyle(geojson_right._layers[letid]);
				}
			}
		}

		// create the legend of the differences
		createLegendDif = function (label, grades, n) {
			grades.push(grades[grades.length-1]+1);
			var div = '<div style="width:130px"><h4>' + label + '</h4>';
			div += '<div style="background:' + getColorDensity(grades[0]-1, n) + ';"> &lt;' + grades[0] + '</div>';
					
				var i=0;
			for (; i+1 < grades.length; i++) {
				if(grades[i]<0){
					div += '<div style="background:' + getColorDensity(grades[i], n) + ';">' + grades[i] 
								+ '&ndash;' + grades[i + 1] + '</div>';
				}else{
					if(grades[i]===0){
						div += '<div style="background:' + getColorDensity(grades[i], n) + ';">' + grades[i] 
									+ '</div>';
					}else{
						div += '<div style="background:' + getColorDensity(grades[i], n) + ';">' + grades[i-1] 
									+ '&ndash;' + grades[i] + '</div>';
					}
				}
			}
			div += '<div style="background:' + getColorDensity(grades[i], n) + ';">' 
						+ (grades[i])+ '+</div>';

			div += '</div>';
			return div;
		};
		
		function getNewTemp(){
			let numb = parseInt(document.getElementById("numberColorDif").value);
			let temp;
			switch(numb){
				case 3: temp=[]; break;
				case 5: temp=[1/4]; break;
				case 7: temp=[1/2,1/4]; break;
				case 9: temp=[1/2,1/4,1/6]; break;
			}
			return temp;
		}
		
		function getNewGrades(){
			let grades=[];
			let temp=getNewTemp();
			
			for(var i=0; i<temp.length;i++){
				grades.push(colormin*temp[i]);
			}
			grades.push(0);
			for(i--; i>=0; i--){
				grades.push(colormax*temp[i]);
			}
			return grades;
		}
		
		function removeAllLayer(map){
			map.eachLayer(function(layer){
				if(layer===(geojson_mid)){  
					map.removeLayer(layer);
				}
			});
		}
		
		function getColorDensity9(d) {
			return d < colorscaleDif[0] ? "#bd0026": //'#ff3f3f' :
				d < colorscaleDif[1] ? "#f03b20": //"#ff993f" :
				d < colorscaleDif[2] ? "#fd8f3c": //"#FFC63F" :  
				d < colorscaleDif[3] ? "#fecc5c": //"#ffe23f" :
				d > colorscaleDif[6] ? "#006837": //'#20ed83' :
				d > colorscaleDif[5] ? "#31a354": //"#3fff5c" :
				d > colorscaleDif[4] ? "#78c679": //"#91ff42" :  
				d > colorscaleDif[3] ? "#c2e699": //"#d6ff42" :
				"#ffffb2";
		}
		
		function getColorDensity7(d) {
			return d < colorscaleDif[0] ? "#e31a1c": //'#ff3f3f' :
				d < colorscaleDif[1] ? "#fd8d3c": //"#ff993f" : 
				d < colorscaleDif[3] ? "#fecc5c": //"#ffe23f" :
				d > colorscaleDif[6] ? "#238443": //'#20ed83' :
				d > colorscaleDif[5] ? "#78c679": //"#91ff42" : 
				d > colorscaleDif[3] ? "#c2e699": //"#d6ff42" :
				'#ffffb2';
		}

		function getColorDensity5(d) {
				return d < colorscaleDif[1] ? "#f03b20": //'#ff3f3f':
				d < colorscaleDif[3] ?  "#feb24c": //"#ff993f" : 
				d > colorscaleDif[5] ? "#31a354": //'#20ed83' :  
				d > colorscaleDif[3] ? "#addd8e": //"#91ff42" :  
				'#ffffb2';
		}
		
		function getColorDensity3(d) {
				return d < colorscaleDif[3] ? '#f03b20':
				d > colorscaleDif[3] ? '#31a354' :
				'#ffffb2';
		}
		function styleDifference9(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity9(feature.properties.density_diff)
			};
		}
		
		function styleDifference7(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity7(feature.properties.density_diff)
			};
		}
		
		function styleDifference5(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity5(feature.properties.density_diff)
			};
		}
		
		function styleDifference3(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity3(feature.properties.density_diff)
			};
		}
		
		outerLegend = createLegend('Outer Maps');
		midLegend = createLegendDif('Middle Map', colorscaleDif, 9);
		document.getElementById('legendAll').innerHTML = outerLegend + midLegend;
		
		
		
		function selectNumberDifFunc(){
			// selected number
			var numb = parseInt(document.getElementById("numberColorDif").value);
			var newGrades =[];
			
			newGrades = getNewGrades();
			
			midLegend = createLegendDif('Middle Map', newGrades, numb);
			document.getElementById('legendAll').innerHTML = outerLegend + midLegend;
			
			removeAllLayer(midmap);
			
			if(numb===9){
				geojson_mid.setStyle(styleDifference9);
			}
			if(numb===7){
				geojson_mid.setStyle(styleDifference7);
			}
			if(numb===5){
				geojson_mid.setStyle(styleDifference5);
			}
			if(numb===3){
				geojson_mid.setStyle(styleDifference3);
			}
			
			geojson_mid.addTo(midmap);
		}
	</script>
</body>

</html>
