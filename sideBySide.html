<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Side-by-Side</title>

	<link rel="stylesheet" href="./leaflet/leaflet.css" />
	<script src="./leaflet/leaflet.js"></script>
	<script src="./jquery.min.js"></script>
	<script src="./jquery-ui.min.js"></script>
	<script src="./us_states.js"></script>
	<script src="./us_states_2_variation.js"></script>
	<style>
		body {
			font-family: Sans-Serif;
			padding: 0px;
			margin: 0px;
		}

		#outercontrolbox {
			float: right;
			width: 160px;
			height: 100%;
		}

		#controlbox {
			z-index: 10000;
			background-color: #fff;
			border-left: 1px solid gray;
			width: 160px;
			height: 100%;
			position: fixed;
			padding: 10px;
		}


		#map-before,
		#map-after,
		#map-compare {
			width: 900px;
			height: 450px;
			margin: 10px;
		}

		.map {
			border: 1px solid gray;
			border-radius: 2px;
			float: left;
		}

		#container-before,
		#container-compare,
		#container-after {
			float: left;
			width: 100%;
			margin-left: 30px;
		}

		#title-before,
		#title-after,
		#title-compare {
			text-align: center;
			margin: 10px;
			width: 100%;
			float: left;
		}

		#legendAll-before,
		#legendAll-compare,
		#legendAll-after {
			float: left;
			border-radius: 2px;
		}

		#infobox-after,
		#infobox-before,
		#infobox-compare {
			float: left;
			margin: 10px;
			margin-left: 40px;
		}

		hr {
			border: 0;
			height: 1px;
			background: gray;
			float: left;
			width: 100%;
		}
	</style>

</head>

<body>
	<div id="outercontrolbox">
		<div id="controlbox">
			<h3>Stoppuhr:</h3>
			<p id="controltime">nicht gestartet</p>
			<button id="startbutton" onclick="start_stopwatch()">Start</button>
			<br><br>
			<button id="stopbutton" onclick="stop_stopwatch()">Stop</button>
		</div>
	</div>
	<h3 id="title-before">Before</h3>
	<div id="container-before">
		<div class="map" id="map-before"></div>
		<div id="legendAll-before"></div>
	</div>
	<div id="infobox-before">
		<p id="infotext-before">Hover over choropleth shapes to show more information.</p>
	</div>
	<hr>
	<h3 id="title-compare">Comparison</h3>
	<div id="container-compare">
		<div class="map" id="map-compare"></div>
		<div id="legendAll-compare"></div>
	</div>
	<div id="infobox-compare">
		<p id="infotext-compare">Hover over choropleth shapes to show more information.</p>
	</div>
	<hr>
	<h3 id="title-after">After</h3>
	<div id="container-after">
		<div class="map" id="map-after"></div>
		<div id="legendAll-after"></div>
	</div>
	<div id="infobox-after">
		<p id="infotext-after">Hover over choropleth shapes to show more information.</p>
	</div>

	<script>
		var leftmap = L.map('map-before', {
			center: [37.8, -96],
			zoom: 4,
			zoomAnimation: false,
			attributionControl: false,
			zoomControl: false
		});
		var midmap = L.map('map-compare', {
			center: [37.8, -96],
			zoom: 4,
			zoomAnimation: false,
			attributionControl: false,
			zoomControl: false
		});
		var rightmap = L.map('map-after', {
			center: [37.8, -96],
			zoom: 4,
			zoomAnimation: false,
			attributionControl: true,
			zoomControl: false
		});

		var basemap = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';
		var basemap_options = {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'

		};

		L.tileLayer(basemap, basemap_options).addTo(leftmap);
		L.tileLayer(basemap, basemap_options).addTo(midmap);
		L.tileLayer(basemap, basemap_options).addTo(rightmap);

		// the functions from the tutorial to color and style the maps
		function getColor(d) {
			return d > 1000 ? '#084594' : //'#800026' :
				d > 500 ? '#2171b5' : //'#BD0026' :
				d > 200 ? '#4292c6' : //'#E31A1C':
				d > 100 ? '#6baed6' : //'#FC4E2A' :
				d > 50 ? '#9ecae1' : //'#FD8D3C':
				d > 20 ? '#c6dbef' : //'#FEB24C':
				d > 10 ? '#deebf7' : //'#FED976':
				'#f7fbff'; //'#FFEDA0';
		}

		function style(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColor(feature.properties.density)
			};
		}

		function resetInfo(target) {
			$('#infotext-' + target)[0].innerHTML = "Hover over choropleth shapes to show more information.";
		}

		function setInfo(properties, target) {
			if (target == "compare") {
				$('#infotext-' + target)[0].innerHTML = properties.name + ": " + properties.density_diff;
				return;
			}

			$('#infotext-' + target)[0].innerHTML = properties.name + ": " + properties.density;
		}

		function highlightFeatureL(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 3,
				color: '#55DDFF',
				dashArray: '',
				fillOpacity: 1
			});

			layer.bringToFront();
			setInfo(layer.feature.properties, "before");
		}

		function highlightFeatureM(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 3,
				color: '#55DDFF',
				dashArray: '',
				fillOpacity: 1
			});

			layer.bringToFront();
			setInfo(layer.feature.properties, "compare");
		}

		function highlightFeatureR(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 3,
				color: '#55DDFF',
				dashArray: '',
				fillOpacity: 1
			});

			layer.bringToFront();
			setInfo(layer.feature.properties, "after");

		}


		function resetHighlightR(e) {
			geojson_right.resetStyle(e.target);
			resetInfo("after");
		}

		function resetHighlightL(e) {
			geojson_left.resetStyle(e.target);
			resetInfo("before");
		}

		function onEachFeatureR(feature, layer) {
			layer.on({
				mouseover: highlightFeatureR,
				mouseout: resetHighlightR
			});
		}

		function onEachFeatureL(feature, layer) {
			layer.on({
				mouseover: highlightFeatureL,
				mouseout: resetHighlightL
			});
		}


		// creating the difference map + color scale
		var diffData = {
			"type": "FeatureCollection",
			"features": []
		};
		var colormin = 0;
		var colormax = 0;
		var leftlowerhalf = 0;
		var leftmiddlequarter = 0;

		var rightmiddlequarter = 0;
		var rightupperhalf = 0;
		// the inner quarters are < or > 0

		for (let dataset = 0; dataset < statesData.features.length; dataset++) {
			let ldata = statesData.features[dataset];
			let rdata = statesData2.features[dataset];

			// generate difference choropleth dataset
			let newdata = {
				type: "Feature",
				id: "" + (dataset + 1) + "",
				properties: {
					name: ldata.properties.name,
					density_diff: rdata.properties.density - ldata.properties.density,
					density_left: ldata.properties.density,
					density_right: rdata.properties.density
				},
				geometry: ldata.geometry
			};

			// search for lowest/highest values
			if (newdata.properties.density_diff < colormin) colormin = newdata.properties.density_diff;
			if (newdata.properties.density_diff > colormax) colormax = newdata.properties.density_diff;
			diffData.features.push(newdata);
		}

		// create color scale
		var colorscaleDif = [colormin / 2, colormin / 4, colormin / 6, 0, colormax / 6, colormax / 4, colormax / 2];

		function getColorDensity(d) {
			return d < colorscaleDif[1] ? "#f03b20" : //'#ff3f3f':
				d < colorscaleDif[3] ? "#feb24c" : //"#ff993f" : 
				d > colorscaleDif[5] ? "#31a354" : //'#20ed83' :  
				d > colorscaleDif[3] ? "#addd8e" : //"#91ff42" :  
				'#ffffb2';
		}


		function styleDifference(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity(feature.properties.density_diff)
			};
		}

		function resetHighlightM(e) {
			selectNumberDifFunc();
			resetInfo("compare");
		}

		function onEachFeatureM(feature, layer) {
			layer.on({
				mouseover: highlightFeatureM,
				mouseout: resetHighlightM
			});
		}

		var geojson_mid = L.geoJson(diffData, {
			style: styleDifference,
			onEachFeature: onEachFeatureM
		}).addTo(midmap);

		function styleDifference(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 1,
				fillColor: getColorDensity(feature.properties.density_diff)
			};
		}

		function selectNumberDifFunc() {
			// selected number
			var newGrades = [];

			newGrades = getNewGrades();

			midLegend = createLegendDif('Middle Map', newGrades);
			document.getElementById('legendAll-compare').innerHTML = midLegend;

			midmap.eachLayer(function (layer) {
				if (layer === (geojson_mid)) {
					midmap.removeLayer(layer);
				}
			});


			geojson_mid.setStyle(styleDifference);


			geojson_mid.addTo(midmap);
		}



		// create the legend of the differences
		function createLegendDif(label, grades) {
			grades.push(grades[grades.length - 1] + 1);
			var div = '<div style="width:130px"><h4>' + label + '</h4>';
			div += '<div style="background:' + getColorDensity(grades[0] - 1) + ';"> &lt;' + grades[0] + '</div>';

			var i = 0;
			for (; i + 1 < grades.length; i++) {
				if (grades[i] < 0) {
					div += '<div style="background:' + getColorDensity(grades[i]) + ';">' + grades[i] +
						'&ndash;' + grades[i + 1] + '</div>';
				} else {
					if (grades[i] === 0) {
						div += '<div style="background:' + getColorDensity(grades[i]) + ';">' + grades[i] +
							'</div>';
					} else {
						div += '<div style="background:' + getColorDensity(grades[i]) + ';">' + grades[i - 1] +
							'&ndash;' + grades[i] + '</div>';
					}
				}
			}
			div += '<div style="background:' + getColorDensity(grades[i]) + ';">' +
				(grades[i]) + '+</div>';

			div += '</div>';
			return div;
		};

		function getNewGrades() {
			let grades = [];
			let temp = [1 / 4];

			for (var i = 0; i < temp.length; i++) {
				grades.push(colormin * temp[i]);
			}
			grades.push(0);
			for (i--; i >= 0; i--) {
				grades.push(colormax * temp[i]);
			}
			return grades;
		}

		// load data into the maps
		var geojson_left = L.geoJson(statesData, {
			style: style,
			onEachFeature: onEachFeatureL
		}).addTo(leftmap);

		var geojson_right = L.geoJson(statesData2, {
			style: style,
			onEachFeature: onEachFeatureR
		}).addTo(rightmap);

		// create the legend
		createLegend = function (label) {
			var div = '<div style="width:130px"><h4>' + label + '</h4>';
			var grades = [0, 10, 20, 50, 100, 200, 500, 1000];


			for (var i = 0; i < grades.length; i++) {
				div += '<div style="background:' + getColor(grades[i] + 1) + ';">' +
					grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '</div>' : '+</div>');
			}

			div += '</div>';
			return div;
		};

		document.getElementById('legendAll-compare').innerHTML = createLegendDif("Legend", getNewGrades())
		document.getElementById('legendAll-before').innerHTML = createLegend('Legend');
		document.getElementById('legendAll-after').innerHTML = createLegend('Legend');

		// stopwatch
		var stopwatch_running = false;
		var stopwatch_starttime = (new Date()).getTime();
		var stopwatch_interval;

		function start_stopwatch() {
			if (!stopwatch_running) {
				stopwatch_running = true;
				stopwatch_starttime = new Date().getTime();
				stopwatch_interval = setInterval(function () {
					let passed_time = (new Date().getTime() - stopwatch_starttime) / 1000;
					document.getElementById("controltime").innerHTML = passed_time + " s";
				}, 30);
			}
		}

		function stop_stopwatch() {
			if (stopwatch_running) {
				stopwatch_running = false;
				clearInterval(stopwatch_interval);
			}
		}
	</script>
</body>

</html>